services:
  postgres:
    image: postgres:17-alpine
    ports: ["5432:5432"]
    environment:
      POSTGRES_DB: kart
      POSTGRES_USER: kart
      POSTGRES_PASSWORD: kart
    volumes: [pgdata:/var/lib/postgresql/data]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U kart"]
      interval: 5s
      retries: 5

  api:
    build: .
    ports: ["8080:8080"]
    environment:
      KART_DATABASE_URL: postgres://kart:kart@postgres:5432/kart?sslmode=disable
      KART_API_KEY_PEPPER: dev-pepper-not-for-production
      OTEL_SERVICE_NAME: kart-api
      # Traces: push via gRPC to Tempo.
      OTEL_TRACES_EXPORTER: otlp
      OTEL_EXPORTER_OTLP_TRACES_ENDPOINT: http://tempo:4317
      OTEL_EXPORTER_OTLP_TRACES_PROTOCOL: grpc
      # Metrics: push via OTLP HTTP to Prometheus.
      OTEL_METRICS_EXPORTER: otlp
      OTEL_EXPORTER_OTLP_METRICS_ENDPOINT: http://prometheus:9090/api/v1/otlp/v1/metrics
      OTEL_EXPORTER_OTLP_METRICS_PROTOCOL: http/protobuf
      # Profiling: push to Pyroscope.
      PYROSCOPE_ENABLE: "true"
      PYROSCOPE_APP_NAME: kart-api
      PYROSCOPE_URL: http://pyroscope:4040
    depends_on:
      postgres: { condition: service_healthy }
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/readyz"]
      interval: 10s
      retries: 3

  seed:
    build: .
    entrypoint: ["/app/seed-db"]
    environment:
      DATABASE_URL: postgres://kart:kart@postgres:5432/kart?sslmode=disable
      KART_SEED_API_KEY: dev-api-key-not-for-production
      KART_API_KEY_PEPPER: dev-pepper-not-for-production
    depends_on:
      api: { condition: service_healthy }
    restart: "no"

  prometheus:
    image: prom/prometheus:v3.2.1
    ports: ["9090:9090"]
    volumes: [./deploy/prometheus.yml:/etc/prometheus/prometheus.yml:ro]
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--web.enable-otlp-receiver"

  tempo:
    image: grafana/tempo:2.7.1
    ports: ["4317:4317"]
    volumes: [./deploy/tempo.yml:/etc/tempo.yaml:ro]
    command: ["-config.file=/etc/tempo.yaml"]

  pyroscope:
    image: grafana/pyroscope:1.18.1
    ports: ["4040:4040"]

  grafana:
    image: grafana/grafana:11.5.1
    ports: ["3000:3000"]
    volumes:
      - ./deploy/grafana/datasources.yml:/etc/grafana/provisioning/datasources/datasources.yml:ro
      - ./deploy/grafana/dashboards.yml:/etc/grafana/provisioning/dashboards/dashboards.yml:ro
      - ./deploy/grafana/dashboards:/etc/grafana/dashboards:ro
    environment:
      GF_AUTH_ANONYMOUS_ENABLED: "true"
      GF_AUTH_ANONYMOUS_ORG_ROLE: Admin
    depends_on: [prometheus, tempo, pyroscope]

volumes:
  pgdata:
